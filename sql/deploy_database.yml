steps:
- task: AzureCLI@2
  displayName: Deploy $(Build.Repository.Name) Artifact to environment."
  inputs:
    azureSubscription: '${{ parameters.azureSubscription }}'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript:  |
      az sql server firewall-rule create -g ${{ parameters.resourceGroup }} -s ${{ parameters.serverName }} -n "${{ parameters.azureFirewallRule}}" --start-ip-address ${{ parameters.agentPublicIP }} --end-ip-address ${{ parameters.agentPublicIP }}
      ./tools/sqlpackage /Action:Publish -p:ScriptDatabaseCompatibility=true /SourceFile:"$(Pipeline.Workspace)/$(Build.Repository.Name).Dacpac/${{ parameters.databaseName }}.dacpac" /TargetConnectionString:"${{ parameters.connectionString }}" /Profile:"$(Pipeline.Workspace)/$(Build.Repository.Name).Dacpac/${{ parameters.databaseName }}.publish.xml"
      result=$?
      az sql server firewall-rule delete -g ${{ parameters.resourceGroup }} -s ${{ parameters.serverName }} -n "${{ parameters.azureFirewallRule}}"
      exit $result